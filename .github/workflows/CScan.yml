name: Shell Script Security

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # --- ShellCheck for Bash scripts ---
      - name: Setup ShellCheck (Bash)
        run: |
          echo "Setting up ShellCheck..."
          sudo apt-get update
          sudo apt-get install -y shellcheck
          echo "ShellCheck setup complete."

      - name: ShellCheck Scan (Bash)
        shell: bash
        run: |
          echo "Starting ShellCheck scan for .sh files..."
          output_file="shellcheck_output.txt"

          # Check if any .sh files exist
          if find . -type f -name "*.sh" -print0 | grep -q .; then
            # Run shellcheck and redirect its output to the temporary file
            find . -type f -name "*.sh" -print0 | xargs -0 shellcheck > "$output_file" 2>&1

            # Check if the output file is empty
            if [ -s "$output_file" ]; then
              echo "--- ShellCheck Issues Found ---"
              cat "$output_file" # Print the captured output
              echo "------------------------------"
              exit 1 # Fail the step if issues were found
            else
              echo "✅ ShellCheck completed: No issues found in shell scripts."
            fi
          else
            echo "ℹ️ No shell scripts (.sh files) found to scan."
          fi

          # Clean up the temporary file
          rm -f "$output_file"

      # --- PSScriptAnalyzer for PowerShell scripts ---
      - name: Set up PowerShell
        uses: Amadevus/pwsh-script@97a8b211a5922816aa8a69ced41fa32f23477186 #v2.0.3
        # REMOVED: with: powershell-version: '7.2'  <-- This was the cause of the first warning

      - name: Confirm PowerShell Setup
        run: echo "PowerShell setup complete (using default runner version)." # Adjusted message

      - name: PSScriptAnalyzer (PowerShell)
        shell: pwsh
        run: |
          echo "Installing PSScriptAnalyzer module..."
          Install-Module -Name PSScriptAnalyzer -Force -ErrorAction Stop
          echo "PSScriptAnalyzer installed."

          echo "Starting PSScriptAnalyzer scan for .ps1 files..."
          $outputFile = "psscriptanalyzer_output.txt"

          $ps1Files = Get-ChildItem -Recurse -Path . -Filter "*.ps1" | Select-Object -ExpandProperty FullName
          if ($ps1Files) {
              # Clear the output file before appending new results
              Set-Content -Path $outputFile -Value "" -Encoding Utf8

              # Iterate through each file and analyze it
              foreach ($file in $ps1Files) {
                  # Optional: Write-Host "Analyzing $($file)..."
                  Invoke-ScriptAnalyzer -Path $file -Severity Warning | Out-File -FilePath $outputFile -Append -Encoding Utf8
              }

              # Check if the output file is empty
              if ((Get-Item $outputFile).Length -gt 0) {
                  Write-Host "--- PSScriptAnalyzer Issues Found ---"
                  Get-Content $outputFile
                  Write-Host "------------------------------------"
                  exit 1
              } else {
                  Write-Host "✅ PSScriptAnalyzer completed: No issues found in PowerShell scripts."
              }
          } else {
              Write-Host "ℹ️ No PowerShell scripts (.ps1 files) found to scan."
          }

          # Clean up the temporary file
          Remove-Item -Path $outputFile -ErrorAction SilentlyContinue
